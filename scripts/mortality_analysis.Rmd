---
title: "Semibalanus mortality analysis"
author: "Amelia Hesketh"
date: "06/10/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Objectives

Following the heat dome of 2021, my goal was to document resultant impacts on the mortality of the bed-forming thatched barnacle <i>Semibalanus cariosus</i>, and the determine the dominant factors underlying any mortality patterns observed.

## Data involved

The response, barnacle mortality, is a percentage value obtained by counting the number of live and number of dead barnacles present in 12.7 x 12.7 cm quadrats along haphazardly placed transects at each site (10 quadrats/transect, 1-3 transects per site). Algal cover and the number of anemones (<i>Anthopleura elegantissima</i>) in each quadrat were documented in most cases to serve as covariates.

Temperature data was obtained from Climate Canada. While numerous temperature metrics may be suitable, we will attempt to use the a) mean daily maximum temperature during the heat dome period in British Columbia (June 25-29), and b) mean daily maximum temperature during the start of summer to the time of each mortality survey.

In addition, we will consider the dominant shore aspect and timing of the low tide (to the nearest hour).

We hypothesize that:

1. Mortality will increase with higher air temperature (both for the heat wave and overall during summer).
2) Mortality will increase with proximity of shore aspect to the south
3) Mortality will increase as the tide falls later in the day (to coincide with high air temps). Air temp * time of tide will be significant since high max air temp later in the day will have no bearing on survival if barnacles immersed.
4) Mortality will be reduced by algal cover since this buffers extreme temp.

## Modeling approach

We will attempt to model mortality using a generalized linear modeling approach with a beta family (given that proportion data are being used). We may need to transform the data in order to pull zero mortality data above zero, since GLMMTMB can only handle data on the interval (0,1), not [0,1].

## Assembling temperature data

```{r, results='hide', message = F}
library(tidyverse)
library(lubridate)

# first, assemble all relevant air temperature data

temp.files <- list.files("../raw_data/air_temp/")

# join together all the files

for (file in 1: length(temp.files)){
  file.name = paste("../raw_data/air_temp/", temp.files[file], sep = "")
  file.name.len = nchar(file.name)
  site.name = substr(file.name, (file.name.len-5), (file.name.len-4))
  temp.df <- read_csv(file.name, col_select = c(5:8, 10, 14)) %>% 
    filter(`Date/Time` >= "2021-06-01" & `Date/Time` < "2021-09-01") %>% 
    mutate(site_code = site.name)
  if (file == 1){
    temp.df.all <- temp.df
  }
  if (file > 1){
    temp.df.all <- rbind(temp.df.all, temp.df)
  }
}

# now to rename the columns for ease of coding later
temp.df.rename <- temp.df.all %>% rename("date" = 1, "year" = 2,"month" = 3, "day" = 4, "max_temp_C" = 5, "mean_temp_C" = 6)

# need to next associate each site with a sampling date, and filter out any temp data that was recorded after

survey.info <- read_csv("../raw_data/SBC_siteinformation.csv") %>% 
  select(site_code, latitude_degrees, longitude_degrees, mortality, mortality_survey, aspect) %>% 
  na.omit() %>% mutate(degrees_from_north = case_when(aspect == "N" ~ 0, aspect == "S" ~ 180, aspect == "W" ~ 90, aspect == "E" ~ 90, aspect == "NW" ~ 45, aspect == "SW" ~ 135, aspect == "NE" ~ 45, aspect == "SE" ~ 135))

survey.dates <- survey.info %>% select(site_code, mortality_survey)

# now join to temperature data, leaving out sites we don't yet have mortality data for

required.temp.data <- temp.df.rename %>% right_join(survey.dates) %>% 
  filter(date < mortality_survey) %>% select(-mortality_survey)

# now summarize mean daily temperature values that we care about across whole period

temp.summary <- required.temp.data %>% 
  group_by(site_code) %>% summarize(mean_daily_temp = mean(mean_temp_C, na.rm=T), mean_daily_max_temp = mean(max_temp_C, na.rm=T))

# now just for the heat wave period

temp.hw.only <- temp.df.rename %>% filter(date <= "2021-06-29" & date >= "2021-06-25")

temp.hw.summary <- temp.hw.only %>% 
  group_by(site_code) %>% summarize(mean_daily_temp_hw = mean(mean_temp_C, na.rm=T), mean_daily_max_temp_hw = mean(max_temp_C, na.rm=T))

# join to site information data frame

explanatory.variables <- survey.info %>% left_join(temp.hw.summary) %>% 
   select(-mortality, -mortality_survey, -latitude_degrees)

```

# Assembling tide data

```{r}

tides_cp <- read_delim("../raw_data/tides/tides_CP.csv", col_names = c("date","junk","time","tz","tide_height_m")) %>% mutate(hour = hour(time), site_code = "CP") %>% select(-junk, -tz, -time)

tides_tp <- read_delim("../raw_data/tides/tides_TP.csv", col_names = c("date","junk","time","tz","tide_height_m")) %>% mutate(hour = hour(time), site_code = "TP") %>% select(-junk, -tz, -time) 

tides_rest <- read_csv("../raw_data/tides/tides_other_sites.csv") %>% pivot_longer(names_to = "hour", values_to = "tide_height_m", cols = 3:length(.)) %>% mutate(hour = as.integer(hour))

tides_full <- rbind(rbind(tides_cp, tides_tp),tides_rest)

#write_csv(tides_full, "../clean_data/SBHW_tides_clean.csv")

tides_summary <- tides_full %>% group_by(site_code, date) %>% mutate(low_water = min(tide_height_m)) %>% ungroup() %>% filter(tide_height_m == low_water) %>% group_by(site_code) %>% summarize(mean_low_tide_time = mean(hour))

with.tides <- explanatory.variables %>% left_join(tides_summary)

```


# Generating dataframe for modeling

```{r, message = F, results = "hide"}
# now to get response data read in

mortality <- read_csv("../raw_data/mortality/SBC_MORT_surveys.csv") %>% 
  select(-cover_live, -cover_dead, -algal_cover_per25sq) %>% filter((site_code == "CP" & transect == 3) == F)

mort.model.df <- mortality %>% full_join(with.tides) %>% 
  mutate(prop_dead = number_dead/(number_dead+number_live))

```
```{r}
# examining the mortality data

hist(mort.model.df$prop_dead, breaks = 50, xlab = "Proportion dead", main = "Histogram of mortality data")

```

Based on the distribution of these data, a beta model may not be the way to go. The data have an extreme case of zero-inflation, but I don't believe that different processes are causing mortality vs. no mortality, so a hurdle ZOIB model seems inappropriate. Starting off with a Tweedie distribution, while imperfect, may be the best option.

# Model building

Our initial explantory variables will include:

- mean max daily temperature (whole period)
- mean max daily temperature (heat dome only) 
- longitude 
- algal cover 
- number of anemones

Random effects will include:

- site
- transect nested within site

```{r, message=F, results="hide"}
library(lme4)
library(glmmTMB)
library(GGally)
library(DHARMa)
library(car)
```

```{r}
# check correlation of temperature variables
#ggpairs(mort.model.df %>% select(mean_daily_max_temp,mean_daily_max_temp_hw,mean_daily_temp,mean_daily_temp_hw))

```
```{r}

mort.mod.0 <- glmmTMB(prop_dead ~ mean_daily_max_temp_hw + mean_low_tide_time + algal_prop_cover + degrees_from_north + (1 | site_code), data = mort.model.df, family = binomial(link = "logit"))

plot(density(residuals(mort.mod.0, type = "response"))) # has a long tail ... data are overdispersed ... need to look at other fixes.

mort.mod.0.1 <- glmmTMB(prop_dead ~ mean_daily_max_temp_hw + mean_low_tide_time + algal_prop_cover + degrees_from_north + (1 | site_code), data = mort.model.df, family = binomial(link = "logit"))

mort.mod.1 <- glmmTMB(prop_dead ~ mean_daily_max_temp_hw + mean_low_tide_time + algal_prop_cover + degrees_from_north + (1 | site_code), data = mort.model.df, family = tweedie())
print(mort.mod.1)
# I can't add in a nested random variable for transect within site without causing convergence issues.

plot(simulateResiduals(mort.mod.1))

```

The residuals look reasonable!
 
```{r}

summary(mort.mod.1)
plot(residuals(mort.mod.1))

x <- predict(mort.mod.1, type = "response")
y <- mort.mod.1$frame$prop_dead
cor(y,x)^2


```
 
```{r}
Anova(mort.mod.1)


```

```{r, include=F, results="hide"}

mort.summary <- mort.model.df %>% mutate(site_code = factor(site_code)) %>% group_by(site_code, longitude_degrees, degrees_from_north, mean_low_tide_time) %>% summarize(average_mort = mean(prop_dead, na.rm = T), average_maxtemp = mean(mean_daily_max_temp_hw)) %>% mutate(site_code = factor(site_code))

library(wesanderson)

```

# Plots

The follows are some plots that might be of interest.

First, a plot of mortality across sites, coded by temperature (note that sites are arranged from W to E in their longitude across the x-axis).

```{r, echo = F}
require(tidyverse)
require(viridis)

ggplot(data = mort.summary, aes(x = average_maxtemp, y = average_mort*100)) + geom_point(size = 5) + scale_color_viridis() + geom_point(size = 5, pch = 1, color = "black") + theme_bw() +labs(y = "Mortality (%)", x = "Mean maximum daily temperature during heat wave (ºC)", col = "Aspect") + theme(axis.title = element_text(size = 14), axis.text = element_text(size = 12), legend.text = element_text(size = 12), legend.title = element_text(size = 14))

ggplot(data = mort.summary, aes(x = average_maxtemp, y = average_mort*100, col = degrees_from_north)) + geom_point(size = 5) + scale_color_viridis() + geom_point(size = 5, pch = 1, color = "black") + theme_bw() +labs(y = "Mortality (%)", x = "Mean maximum daily temperature during heat wave (ºC)", col = "Aspect") + theme(axis.title = element_text(size = 14), axis.text = element_text(size = 12), legend.text = element_text(size = 12), legend.title = element_text(size = 14))

```

```{r}
ggplot(data = mort.summary, aes(x = degrees_from_north, y = average_mort*100)) + geom_point(size = 5) + geom_point(size = 5, pch = 1, color = "black") + theme_bw() +labs(y = "Mortality (%)", x = "Dominant shore aspect (degrees away from north = 0º)") + theme(axis.title = element_text(size = 14), axis.text = element_text(size = 12), legend.text = element_text(size = 12), legend.title = element_text(size = 14))
```


Understandable, then, why there is no effect of temperature in the model. Or longitude. The patterns are all over the place. I suspect this is due to differences in aspect, which may be more important than prevailing air temperature.

- some metric of distance from outer coast is probably better than longitude. Maybe use qGIS?
- some weather data may not be accurate (in particular, for Calvert Island)
