---
title: "Semibalanus shading experiment"
author: "Amelia Hesketh"
date: "06/10/2021"
output: html_document
---

# Objectives

This experiment is designed to document how communities differ (in terms of Shannon diversity, species richness, and total abundance of organisms) between Semibalanus beds that are shaded vs. unshaded during the summer season. Shades reduce temperature (and desiccation stress). I also scraped a subset of plots to see how early succession is affected by the presence or absence of shades.

I want to examine: 1) How communities differ in mulitdimensional space between treatments - what is their dispersion, and how far apart are they? 2) How Shannon diversity differs 3) How richness differs 4) How total abundance differs

# Temperature data

```{r, message=F, results="hide", warning=FALSE}
pkgs <- c("tidyverse", "lubridate", "car", "vegan", "plotrix", "patchwork")
lapply(pkgs, library, character.only = T)
rm(pkgs)

temp.files <- list.files("../raw_data/ibutton_temp/")

temp.df.all.aug <- data.frame(matrix(ncol = 4))
colnames(temp.df.all.aug) <- c("Date/Time", "Unit", "Value", "file_name")

for (file in 1: length(temp.files)){
  file.name = paste("../raw_data/ibutton_temp/", temp.files[file], sep = "")
  temp.df <- read_csv(file.name, skip = 14) %>% mutate(file_name = temp.files[file])
  if (str_detect(file.name, "07")==TRUE){
    if (file == 1){
    temp.df.all.july <- temp.df
  }
  if (file > 1){
    temp.df.all.july <- rbind(temp.df.all.july, temp.df)
  }
  }
  else {
    temp.df.all.aug <- rbind(temp.df.all.aug, temp.df)
  }
}

temp.df.clean.july <- temp.df.all.july %>% mutate(Value = str_remove_all(Value, "C,")) %>% separate(file_name, sep = "_", into = c("block","treatment","extra")) %>% select(-extra) %>% rename(date = 1, time = 2, temperature_C = 3) %>%
mutate(time = toupper(str_remove_all(time, fixed(".")))) %>% mutate(time = parse_time(time, "%I:%M:%S %p")) %>% unite(date_time, c(date, time), sep = " ") %>% mutate(date_time = as_datetime(date_time), temperature_C = as.numeric(temperature_C))

temp.df.clean.aug <- temp.df.all.aug %>% na.omit() %>% select(-Unit) %>% separate(file_name, sep = "_", into = c("block","treatment","extra")) %>% select(-extra) %>% rename(date_time = 1, temperature_C = 2) %>% mutate(date_time = parse_date_time(date_time, "%d/%m/%y %I:%M:%S %p"))

temp.clean <- temp.df.clean.aug %>%  full_join(temp.df.clean.july) %>% mutate(treatment = case_when(treatment == 1 ~ "UI", treatment == 2 ~ "SI", treatment == 3 ~ "UR", treatment == 4 ~ "SR")) %>% filter(date_time < "2021-08-21 6:00:00" & date_time > "2021-04-17 15:00:00") %>% unique()

#write_csv(temp.clean, "../clean_data/SBHW_temp_clean.csv")

# isolate low tide data only

temp.rounded <- temp.clean %>% mutate(hour = hour(date_time)) %>% separate(date_time, into = c("date","time"), sep = " ") %>% unite(date_time, c(date, hour), sep = " ") %>% mutate(date_time = ymd_h(date_time)) %>% select(-time) 

tides_sa <- read_delim("../raw_data/tides/tides_all_summer_SA.csv", col_names = c("date","junk","time","tz","tide_height_ft"), delim = " ") %>% mutate(hour = hour(time)) %>% select(-junk, -tz, -time) %>% unite(date_time, c(date, hour), sep = " ") %>% mutate(date_time = ymd_h(date_time), tide_height_m = tide_height_ft * 0.3048) %>% select(-tide_height_ft)

temp.lowtide <- temp.rounded %>% left_join(tides_sa) %>% filter(tide_height_m <= 1.4)

```

```{r}

temp.sep <- temp.lowtide %>% separate(date_time, into = c("date","time"), sep = " ", remove = F)

temp.hourly <- temp.lowtide %>% group_by(date_time, treatment) %>% summarize(mean_temp = mean(temperature_C)) %>% separate(date_time, into = c("date","time"), sep = " ", remove = F) %>% mutate(date_time = ymd_hms(date_time))

temp.summary <- temp.sep %>% group_by(date, block, treatment) %>% summarize(max_temp = max(temperature_C)) %>% mutate(date = date(date)) %>% ungroup() %>% group_by(date, treatment) %>% summarize(mean.max.temp = mean(max_temp), se.max.temp = std.error(max_temp))

wide.temp.trace <- ggplot(data = temp.summary %>% filter(date >= "2021-05-01" & date < "2021-08-15") , aes(x = date, y = mean.max.temp, col = treatment, fill = treatment)) + geom_line() + theme_bw() + scale_color_manual(values = c("skyblue4","skyblue2", "tomato4", "tomato2")) + scale_fill_manual(values = c("skyblue4","skyblue2", "tomato4", "tomato2")) + labs(x = "Date", y = "Mean daily max aerial temperature (ºC)", color = "Treatment", fill = "Treatment") + theme(axis.title = element_text(size = 14), axis.text = element_text(size = 12), legend.text = element_text(size = 12), legend.title = element_text(size = 14)) + geom_ribbon(aes(ymax = mean.max.temp + se.max.temp, ymin = mean.max.temp - se.max.temp), alpha = 0.3, color = NA) + annotate("rect", xmin = ymd("2021-06-25"), xmax = ymd("2021-06-29"), ymin = 10, ymax = 45, fill = "black",  col = NA, alpha = 0.3)

wide.temp.trace

temp.hw <- temp.rounded %>% separate(date_time, c("date", "time"), " ", remove  = F) %>% filter(date >="2021-06-25" & date <= "2021-06-29") %>% group_by(treatment, date_time) %>% summarize(mean.temp = mean(temperature_C), se.temp = std.error(temperature_C))

heat.dome.trace <- ggplot(data = temp.hw, aes(x = date_time, y = mean.temp, col = treatment, fill = treatment)) + geom_line() + scale_color_manual(values = c("skyblue4","skyblue2", "tomato4", "tomato2")) + scale_fill_manual(values = c("skyblue4","skyblue2", "tomato4", "tomato2")) + labs(x = "Date", y = "Temperature (ºC)", fill = "Treatment", color = "Treatment") + theme_bw() + theme(axis.title = element_text(size = 14), axis.text = element_text(size = 12), legend.text = element_text(size = 12), legend.title = element_text(size = 14)) + geom_ribbon(aes(ymax = mean.temp + se.temp, ymin = mean.temp - se.temp), alpha = 0.3, color = NA) 

temp.traces <- wide.temp.trace / heat.dome.trace + plot_layout(guides = 'collect') + plot_annotation(tag_levels = "A") & theme(plot.tag = element_text(size = 16, face = "bold"), plot.tag.position = c(-0.03,1), plot.margin = margin(t=5,b=5,l=15,r=5, "pt"))

ggsave(temp.traces, filename = "../outputs/S1Fig3.png", height = 6, width = 7, units = "in", scale = 1.3, dpi = 1200)

```

The temperature is highest in the unshaded treatments (as expected) by (at times) a substantial margin. What does this break down to in a boxplot sense?

```{r}

temp.summary2 <- temp.sep %>% group_by(treatment, date, block) %>% summarize(mdmax_temp = max(temperature_C)) %>% mutate(trt_long = case_when(treatment == "SI" ~ "shaded intact", treatment == "UI" ~ "unshaded intact", treatment == "SR" ~ "shaded removal", treatment == "UR" ~ "unshaded removal")) %>% mutate(shading = substr(treatment,1,1), removal = substr(treatment,2,2))

fig5a <- ggplot(data = temp.summary2 %>% filter(mdmax_temp < 50), aes(x = treatment, y = mdmax_temp, col = treatment, fill = treatment)) + geom_boxplot(alpha = 0.4, outlier.size = NA) + scale_color_manual(values = c("skyblue4","skyblue3", "tomato4", "tomato2")) + scale_fill_manual(values = c("skyblue4","skyblue3", "tomato4", "tomato2")) + labs(x = "Treatment", y = "Mean maximum daily temperature (ºC)", color = "Treatment", fill = "Treatment") + theme_classic() + theme(axis.title = element_text(size = 14), axis.text = element_text(size = 12), legend.text = element_text(size = 12), legend.title = element_text(size = 14)) + geom_jitter(width = 0.2, alpha = 0.2) #+ geom_segment(aes(x = 2.35, xend = 1.5, y = 50, yend = 50), col = "black") + annotate("text", x = 2.5, y = 49.5, label = "***", size = 6) + geom_segment(aes(x = 2.65, xend = 3.5, y = 50, yend = 50), col = "black") + geom_segment(aes(x = 1.5, xend = 1.5, y = 50, yend = 45), col = "black") + geom_segment(aes(x = 3.5, xend = 3.5, y = 50, yend = 45), col = "black") 

```

There's something odd going on here with one of the SI plots. Need to look into it a bit more. Solved! Excluded one plot that was problematic.

```{r}
require(car)
require(lme4)

temp.model <- lmer(temperature_C ~ treatment*date_time + (1|block), data = temp.lowtide)

summary(temp.model)

Anova(temp.model)

max.temp.model <- lmer(mdmax_temp ~ shading*removal + (1|block), data = temp.summary2)
plot(simulateResiduals(max.temp.model)) # need to solve homoscedatisicity problems

max.temp.model.glmm <- glmmTMB(mdmax_temp ~ shading*removal + (1|block), data = temp.summary2, dispformula = ~shading+removal)
plot(simulateResiduals(max.temp.model.glmm)) # problem solved!

summary(max.temp.model.glmm)
Anova(max.temp.model.glmm, type = 3)
?Anova
```


# Mortality in shaded vs. unshaded

```{r, message = F, results = "hide"}
barnacle.mort <- read_csv("../raw_data/shade/SBHW_SHADE_semibalanusmort.csv") %>% mutate(prop_mort = (number_dead)/(number_live+number_dead)) %>% filter(prop_mort != "NaN")

plot.info <- read_csv("../raw_data/shade/SBHW_SHADE_plot_info.csv")

mort.complete <- barnacle.mort %>% left_join(plot.info) %>% filter((plot_number %in% c(15,35,36,40)) == F) %>% select(prop_mort, treatment_original_numeric, plot_number, block) %>% rename(treatment = treatment_original_numeric) %>% mutate(treatment = case_when(treatment == 1 ~ "UI", treatment == 2 ~ "SI"))

mort.beds <- mort.complete %>% filter(treatment %in% c("SI","UI")) %>% 
  mutate(mort.tr = (prop_mort*(nrow(mort.complete)-1)+0.5)/nrow(mort.complete))

shade.mort.model <- glmmTMB(mort.tr ~ treatment + (1|block), dispformula = ~treatment, family = beta_family(), data = mort.beds)

plot(simulateResiduals(shade.mort.model))

summary(shade.mort.model)
Anova(shade.mort.model)

```

```{r}
summary(shade.mort.model)

fig5b <- ggplot(mort.beds %>% mutate(treatment = case_when(treatment == "SI" ~ "Shaded", treatment == "UI" ~ "Unshaded")), aes(x = treatment, y = prop_mort, col = treatment, fill = treatment)) + geom_boxplot(alpha = 0.4, outlier.size = NA) + theme_classic() + scale_color_manual( values = c("skyblue4", "tomato4")) + scale_fill_manual(values = c("skyblue4", "tomato4")) + labs(x = "Treatment", y = expression("Proportion"~italic("S. cariosus")~"dead"),col = "Treatment") + theme_classic() + theme(axis.title = element_text(size = 14), axis.text = element_text(size = 12), legend.position = "none") + geom_jitter(width = 0.2, alpha = 0.3)

```

Clearly, having a shade positively affected barnacle survival. What about species richness/diversity based on visual surveys??

```{r,message = F, results = "hide"}

visuals <- read_csv("../raw_data/shade/SBHW_SHADE_visual_3_202108.csv")

# separate the cover and count data

taxa <- read_csv("../raw_data/SBC_taxonomic_20211026.csv") %>% select(taxon_code, kingdom)

algae <- taxa %>% filter(kingdom != "Animalia") %>% select(-kingdom)
animal <- taxa %>% filter(kingdom == "Animalia") %>% select(-kingdom)

# algal diversity & abund

visuals.long <- visuals %>% pivot_longer(cols = c(2:length(visuals)), names_to = "taxon_code", values_to = "abund")

visuals.algae <- visuals.long %>% right_join(algae) %>% pivot_wider(names_from = "taxon_code", values_from = "abund") %>% select(-ULSP) %>% na.omit()

H <- diversity(visuals.algae)
total_cover <- rowSums(visuals.algae %>% select(-plot_number))

diversity.algae <- cbind(visuals.algae$plot_number, H, total_cover)
colnames(diversity.algae) <- c("plot_number","H", "total_cover")
diversity.algae <- as.data.frame(diversity.algae)

diversity.algae.trts <- diversity.algae %>% full_join(plot.info) %>% select(-plot_number, -treatment_final_numeric, -shore_level) %>% rename(treatment = treatment_original_numeric) %>% mutate(treatment = case_when(treatment == 1 ~ "UI", treatment == 2 ~ "SI", treatment == 3 ~ "UR", treatment == 4 ~ "SR"))

# animal diversity & abund

visuals.animals <- visuals.long %>% right_join(animal)  %>% pivot_wider(names_from = "taxon_code", values_from = "abund") %>% mutate_all(~replace_na(.,0)) %>% select(-c(GNOR:NEVE)) %>% na.omit()

H <- diversity(visuals.animals)
abund <- rowSums(visuals.animals %>% select(-plot_number))

diversity.animals <- cbind(visuals.animals$plot_number, H, abund)
colnames(diversity.animals) <- c("plot_number","H", "abund")
diversity.animals <- as.data.frame(diversity.animals)

diversity.animals.trts <- diversity.animals %>% full_join(plot.info) %>% select(-plot_number, -treatment_final_numeric, -shore_level) %>% rename(treatment = treatment_original_numeric) %>% mutate(treatment = case_when(treatment == 1 ~ "UI", treatment == 2 ~ "SI", treatment == 3 ~ "UR", treatment == 4 ~ "SR"))

richness.all.taxa <- cbind(visuals$plot_number, specnumber(visuals))
colnames(richness.all.taxa) <- c("plot_number", "richness")
richness.all.taxa <- as.data.frame(richness.all.taxa)

richness.all.trts <- richness.all.taxa %>% full_join(plot.info) %>% select(-plot_number, -treatment_final_numeric, -shore_level) %>% rename(treatment = treatment_original_numeric) %>% mutate(treatment = case_when(treatment == 1 ~ "UI", treatment == 2 ~ "SI", treatment == 3 ~ "UR", treatment == 4 ~ "SR"))

```

# Plots of diversity & abundance

## 1: Species richness, all taxa

```{r}
ggplot(richness.all.trts, aes(x=treatment, y = richness, color = treatment)) + geom_boxplot() + labs(y = "Species richness", x = "Treatment") + scale_color_manual(values = c("skyblue4","skyblue2", "tomato4", "tomato2")) +  theme(axis.title = element_text(size = 14), axis.text = element_text(size = 12), legend.text = element_text(size = 12), legend.title = element_text(size = 14)) + theme_bw()
```

## 2: Animals only: Shannon diversity & total abundance

```{r}
ggplot(diversity.animals.trts, aes(x=treatment, y = H, color = treatment)) + geom_boxplot() + scale_color_manual(values = c("skyblue4","skyblue2", "tomato4", "tomato2")) +  theme(axis.title = element_text(size = 14), axis.text = element_text(size = 12), legend.text = element_text(size = 12), legend.title = element_text(size = 14)) + theme_bw()
```

```{r}
ggplot(diversity.animals.trts, aes(x=treatment, y = abund, color = treatment)) + geom_boxplot() + scale_color_manual(values = c("skyblue4","skyblue2", "tomato4", "tomato2")) +  theme(axis.title = element_text(size = 14), axis.text = element_text(size = 12), legend.text = element_text(size = 12), legend.title = element_text(size = 14)) + theme_bw()
```

This trend is driven by barnacle recruitment, which was REALLY high in shaded removal plots. Might be worth digging into further??

```{r}

richness <- lm(richness ~ treatment, data = richness.all.trts)
summary(richness)
Anova(richness)

```

```{r}
animal.diversity <- lm(H ~ treatment, data = diversity.animals.trts)
summary(animal.diversity)
Anova(animal.diversity)
```

```{r}

animal.abundance <- lm(abund ~ treatment, data = diversity.animals.trts)
summary(animal.abundance)
Anova(animal.abundance)
```

## 3: Algal diversity & cover

```{r}
ggplot(diversity.algae.trts, aes(x=treatment, y = H, color = treatment)) + geom_boxplot() + scale_color_manual(values = c("skyblue4","skyblue2", "tomato4", "tomato2")) +  theme(axis.title = element_text(size = 14), axis.text = element_text(size = 12), legend.text = element_text(size = 12), legend.title = element_text(size = 14)) + theme_bw()
```

```{r}
ggplot(diversity.algae.trts, aes(x=treatment, y = total_cover, color = treatment)) + geom_boxplot() + scale_color_manual(values = c("skyblue4","skyblue2", "tomato4", "tomato2")) +  theme(axis.title = element_text(size = 14), axis.text = element_text(size = 12), legend.text = element_text(size = 12), legend.title = element_text(size = 14)) + theme_bw()
```

```{r}
algal.diversity <- lm(H ~ treatment, data = diversity.algae.trts)
summary(algal.diversity)
Anova(algal.diversity)
```

```{r}

algal.cover <- lm(total_cover ~ treatment, data = diversity.algae.trts)
summary(algal.cover)
Anova(algal.cover)
```

Moral of the story: The animal component of the community seems way more affected than the algal component.

## Visual surveys NMDS

```{r, message=FALSE, results = "hide"}
comm.visual <- visuals %>% select(-plot_number)
comm.visual.matrix <- as.matrix(comm.visual)
View(visuals)
comm.visual <- metaMDS(comm.visual.matrix, k = 2, try = 999, autotransform = T)

treatment.codes <- as.data.frame(plot.info$treatment_original_numeric) %>% rename(treatment = 1) 


```

```{r}
knitr::include_graphics("../outputs/community_visual_shade.png")
```

```{r, results ="hide",message=FALSE}
perm.y1 <- adonis(comm.visual.matrix ~ treatment, data = treatment.codes, perm = 99)
perm.y1

dist.y1 <- vegdist(comm.visual.matrix, method = "bray")

disp.y1 <- betadisper(dist.y1, type = "centroid", group = treatment.codes$treatment)
anova(disp.y1)

boxplot(disp.y1, xlab = "Treatment")

```


```{r}

comm_ord <- ordiplot(comm.visual, type = "none")
points(comm_ord, what = "sites", col = "black")
orditorp(comm_ord, display="species",col="grey30", air=1)
ordiellipse(comm_ord, groups = treatment.codes$treatment, 
            col = c("tomato4","skyblue4", "tomato2","skyblue2"), lwd = 1.5)
legend("bottom", col = c("tomato4","skyblue4", "tomato2","skyblue2"), legend = c("unshaded intact","shaded intact", "unshaded removal","shaded removal"), bty = "n", lty = 1, lwd = 2)

```



