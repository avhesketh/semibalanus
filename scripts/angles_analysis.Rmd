---
title: "Semibalanus mortality + aspect"
author: "Amelia Hesketh"
date: "06/10/2021"
output: html_document
---

# Objectives

Our mortality analysis has been inconclusive. It seems that no between site information measured can explain patterns in mortality observed. Here, we aim to look at how mortality changes with solar angle, which may explain the severity of heating and the patchiness of mortality within and between sites regardless of prevailing air temperature.

# Data

Data were collected at five sites in haphazardly placed quadrats. The response variable in this case is the proportion dead, while the explanatory variable will be the solar angle.

# Calculating solar angle
```{r, include = F, results="hide"}
# first, load in the relevant packages and data

library(tidyverse)
library(glmmTMB)
library(DHARMa)
library(lme4)
library(car)
library(ggeffects)

angle.data <- read_csv("../raw_data/mortality/SBC_MORT_angles.csv")

site.info <- read_csv("../raw_data/SBC_siteinformation.csv") %>% select(site_code,angles,solar_elevation, solar_azimuth) %>% na.omit() %>% select(-angles)


#join together the dataframes
angle.calculate <- angle.data %>% full_join(site.info)

# the compass orientation needs to be flipped by 180 degrees/pi radians
# the angle needs to be converted from angle from vertical to angle from horizontal
angle.correct <- angle.calculate %>% mutate(orient_rad = (((orientation_raw_degrees/360)*2*pi)-pi), prop_mort = number_dead/(number_live + number_dead), sigma = ((90-angle_raw_degrees)/360)*2*pi, beta = (solar_elevation/360)*2*pi, solar_az_rad = (solar_azimuth/360)*2*pi)

# now for the calculations

solar.angles <- angle.correct %>% mutate(gamma = abs(orient_rad - solar_az_rad)) %>% mutate(theta = acos(sin(beta)*cos(sigma) + cos(gamma)*cos(beta)*sin(sigma))) %>% mutate(angle = (theta/(2*pi)*360)) %>% 
  select(prop_mort, angle, site_code) %>% mutate(site_code = str_replace_all(site_code, "WA","WB"))

```

# Modeling

We may also want to integrate temperature information into the model to see if these two factors are together influential. But for now, keep the model simple. This looks like a beta distribution or 

```{r}
library(lme4)

angle.model.0 <- glmer(prop_mort ~ angle + (1+angle|site_code), family = binomial(link = "logit"), data = solar.angles)

plot(density(resid(angle.model.0, type='deviance')))

qqnorm(residuals(angle.model.0, type = "deviance"))

# looks reasonable 

angle.model.1 <- update(angle.model.0, ~. -(1+angle|site_code) + (1|site_code))

AIC(angle.model.0, angle.model.1) # allowing slope variation for each site is worse

# angle.model.1 it is!

library(car)
library(MuMIn)

summary(angle.model.1)
r.squaredGLMM(angle.model.1)

Anova(angle.model.1)

library(ggeffects)
library(RColorBrewer)

pal <- colorRampPalette(brewer.pal(6, "Dark2"))(6)

set.seed(26)
model.pred <- ggpredict(angle.model.1, terms = c("angle", "site_code"), type = "random") %>% rename(site_code = group)

model.glm <- glm(prop_mort ~ angle, family = "binomial", data = solar.angles)

model.pred2 <- ggpredict(model.glm, terms = c("angle")) %>% select(-group)

ggplot(data = solar.angles, aes(x = angle, y = prop_mort, col = site_code)) + geom_point(size = 2) + labs(y = "Proportion mortality", x = "Substratum orientation (relative to direct sun = 0ยบ)", col = "Site") + theme_classic() + scale_color_manual(values = pal) + scale_fill_manual(values = pal) +  theme(axis.title = element_text(size = 14), axis.text = element_text(size = 12), legend.text = element_text(size = 12), legend.title = element_text(size = 14)) + geom_line(data = model.pred, aes(x = x, y = predicted)) + geom_smooth(method = "glm", method.args = list(family = "binomial"), aes(x = angle, y = prop_mort), col = "black")

```

# Results

The lesser the angle, the higher the mortality (p < 0.001).
